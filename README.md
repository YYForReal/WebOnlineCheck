# Web 在线校验网站

## 一. 效果

### 1.1 教师端

#### 1.1.1 教师端-提交列表

![教师端 提交列表](https://user-images.githubusercontent.com/66943144/210571544-77a195b8-eadc-4f6f-b286-e239c102131c.png)

#### 1.1.2 教师端-实验设置

![教师端-实验设置](https://user-images.githubusercontent.com/66943144/210571594-a3e4c0bb-ef03-44a5-9e85-d948dbad276a.png)

#### 1.1.3 教师端-JS实验的校验代码设置

![教师端JS实验校验代码](https://user-images.githubusercontent.com/66943144/210571748-e3ecfb42-d1ad-4493-a5f4-b99d76fc50d2.png)

#### 1.1.4 教师端-各实验的图片设置

![教师端-图片设置](https://user-images.githubusercontent.com/66943144/210571793-3ec71a49-abca-4ac1-bdc7-f928b74fdce3.png)


### 1.2 学生端


#### 1.2.0 学生端-初始版本
![image](https://user-images.githubusercontent.com/66943144/193014916-08c5c01f-f3a1-4bc4-98f7-8d0da0871f76.png)

![image](https://user-images.githubusercontent.com/66943144/193014829-381c9077-cee9-412f-bcc7-284c59e0a985.png)

#### 1.2.1 学生端-提交列表

![学生端-提交列表](https://user-images.githubusercontent.com/66943144/210572405-86bb79ba-0472-4203-af98-d1b53ed22fc0.png)

#### 1.2.2 学生端-实验图片参考

![学生端-图片参考](https://user-images.githubusercontent.com/66943144/210572436-01fbd732-8c98-4de0-87dd-386ad0646771.png)

#### 1.2.3 学生端-提交提示

![学生端-提示](https://user-images.githubusercontent.com/66943144/210572486-01e7bb3b-01af-4a4f-b433-5e5b151e916d.png)

#### 1.2.4 学生端-实验提交页面

![学生端-提交代码](https://user-images.githubusercontent.com/66943144/210572526-d03f0369-8697-4cd9-98e8-9e7812c34f78.png)



## 网站功能

### 已实现 & 已展示

1. 登录：根据学号姓名登录，可以使用特殊的账号切换到教师端路由。
2. 学生端
   1. 可根据实验题目提交html代码（可反复提交）
   2. 可查看自己已提交的HTML实验，并对JS实验进行校验。
   3. 可查看对应的实验的参考外链图片并快捷复制
   4. 引导功能：使用Driver.js 进行多段引导。
3. 教师端
   1. 可根据{**实验题目**、**学生姓名**、**学号**}筛选查看学生提交内容、分数
      - 更新：可多选实验题目，可搜全部实验提交内容
   2. 可查看学生提交内容及实验比对文本的区别
   3. 可批改、导出**学生分数**及学生实验提交情况 
      - 更新：导出的CSV表格中，若已批改，则显示批改分数；若尚未批改，显示1；若没提交，显示0
      - 更新：JS实验若校验全通过后自动批改100分
   4. 允许设置**实验题目**、**实验HTML模板**、**实验参考图片**、**JS实验校验代码**等相关内容
   5. 可{单独/一键} 比对学生HTML实验运行效果
   6. 具有前端分页功能
4. 接口校验：提交答案及批改评分时会额外校验当前的登录状态。

### 已实现 & 未展示
1. 学生端
   1. 比对效果可根据提交时间定时查看
   2. 允许在教师端评分过后查看自己的比对情况及评分
   3. 展示提交的实验代码。
2. 教师端
   1. HTML页面上展示全部学生的实验成绩。

### 未实现

1. 注册：未开放，需先通过CSV导入数据库
2. 学生端：
   1. 允许自己修改登录密码
3. 教师端：
   1. 查看的学生列表可折叠
   2. 更便捷更智能的全自动校验程序
4. 后端分页功能
5. 鉴权校验功能


## 核心比对功能

> 引用diff.js 实现核心的HTML文本比对
> 引用screenshot-api-server 开源Node项目进行学生页面的截图
> 使用Python 感知哈希算法 进行图像对比和相似度计算
> 通过每个实验独立的校验代码注入，实现对DOM的自动操作模拟JS操作。


### 已实现

  1. 过滤掉html标签，保留标签内部文本
  2. 对比文字内容时从body标签开始，防止被css部分干扰。
  3. 展示页面内容时删除script标签及其内部内容，防止脚本注入。
  4. 可以识别部分的转义符号并提前转化为文本符号。
  5. ⭐实现Web运行效果的图像比对（流程）
     1. 根据回答或问题ID，创建动态路由，该路由显示对应学生的html效果。
        - http://yywebsite.cn/webcheck/#/template?answerId=178 表示显示学生回答ID为178号的html的效果
        - http://yywebsite.cn/webcheck/#/template?questionId=1 表示显示问题ID为1号的html效果（也是比对的效果）
     2. 请求接口/api/img，通过模拟访问对应的url获取对应Web页面的运行截图（base64编码形式）。
        借用Gitee中nop/screenshot-api-server仓库的网页截图功能，通过docker运行在服务器上。
        链接如下：https://gitee.com/wuxue107/screenshot-api-server
     3. 同理，根据动态路由获取对应问题参考答案的运行截图。
     4. 请求接口/answer/compare，比较两个base64编码形式的图片，通过比对色彩直方图数据差异（更新：改为感知哈希），得到两个图像的百分比相似度。
        参考来源：https://www.jb51.net/article/245452.htm
   6. JS实验校对：提取学生JS代码并同各实验校验代码一同注入到校验页面中，模拟DOM操作实现效果检查。
      - 对textarea的innerHTML、value进行数据劫持。
      - 对alert()等警告提示函数 利用函数作用域进行替换。
      - 对异步的indexedDB数据库操作进行同步等待。

### 未实现

    1. 不能校验通过外部script注入的文字（如document.write），只能校验html文件静态的文字。
    2. 不能校验到空格的个数，文本校验时会删除所有的空格。
    3. 可能出现其他没考虑到的转义符号，后续可以根据情况增加。
    4. CSS校验
    6. 高级目标：实现最精确的文本判别并自动评分
    7. 终极目标：实现Web整体效果的比对及自动判别

## 其他部分

### 待实现
   1. 提高接口返回的数据规范
   2. 接口安全性的提高，需增加防御机制（断言，过滤），防SQL注入
   3. 整体UI界面的优化
   4. 数据库字段间的限制关系存在优化空间


## 更新日志

### 2022.9.20
- 起因
担任Web助教，花了一天多实现了一个简单的具有文本校验功能的HTML文件。学生只需要提交html文件，通过预先定义好的文本，直接校对即可。

- 出现问题
  1. 我迄今都忘不了他们排着队靠U盘拷他们的html文件过来的场景。这方式好呆，好费时。所以也就有了后续搭建线上提交代码的需求了。
  2. 选择有些人的HTML文件时会出现乱码的情况，应该是这里只是默认的UTF-8编码，而他们的html文件的编码方式好像是ANSII码形式的，需要转一下文件格式成txt，另存为的时候修改编码方式，再转文件格式。

### 2022.9.27
- 第一次实践
这周实现了Web校验网站的前后端构建，学生端可以提交答案，查看分数（默认0分）。教师端可以查看提交的文本，批改分数+查看分数。提交的实验其实只有一个，所幸撑下来了。

- 需求
  1. 学生提交后可以定时查看对应的文本比对效果。
  2. 除了文本比对外，可以实现Web效果的比对。（运行截图的比对）

就是这时候老师提到了一个从来没听过的RPA技术，机器人（模拟）访问页面，这个页面是学生提交的HTML代码的页面，然后截图（记图1），教师端的配置中，输入的正确的html代码，机器人同样模拟访问，截图（记图2）。通过对比图1图2实现Web效果的比对。


### 2022.10.11

已经做这个系统将近一个月了，可能后面也有一些更新，改动。但是居然这时候才想起来记录一下自己做的功能。
虽然只有一个多月，但还是有反复横跳的一些功能点，比如分数的批改，虽然实现了，但是却没有实际使用，所以又注释掉了不少功能。还有学生端定时查看文字比对的效果，这个虽然实现了，但是也被注释掉了。

- 实现
   1. 增加教师端的html答案编辑
   2. 增加图像比对+相似度分析
   3. 实现定时查看
   5. 增加html效果查看的动态路由

- 出现问题
  1. 网站崩了。估计是因为增加了图像比对的请求，导致SQL的连接取消掉了。后续卡死，被迫重启服务器。（80人的请求量就受不了了...）
  2. 学生提交了上百份，图像比较的请求量因此暴增。
  3. 预览效果的时候，html代码内部的CSS会影响外部的div样式。

- 心得
  1. 不要mounted就直接请求，应该动态筛选一些没有必要的请求；
  2. 关掉一些服务器之前开着，但是现在已经没有用的后端程序。

- 后续实现
  - 学生端：增加效果查看，去除文本对比的查看功能；增加图像外链参考模块。
  - 教师端：完善实验|姓名|学号独立检索功能，去除比对文本的查看卡片，增加分页模块。增加图像校对的一键比对及单独比对开关(链式调用比对请求)。


### 2022.10.14

- 教师端实现
  1. 实现一键比对，教师端链式调用请求图像对比的接口
  2. 增加图像外链参考模块的后台编辑功能（CRUD）
  3. 增加外部云函数，记录后台管理人员的登录日志。（防泄露）
  4. 增加路由守卫，防止学生直接通过网址进入后台。


- 学生端实现
  1. 增加图像外链的接口引入，实现一键复制功能。


### 2022.10.18

- 后端
  1. 使用Redis做缓存，缓存获取的问题列表，图片外链列表以及用户token类型的校验。
  2. 完善更新对应的问题，图片列表信息时删除缓存。

- 前端
  1. 修复跳转页面时的数据重置问题
  2. 完善图像检索的时机及按需检索。对问题列表选择的”防抖“操作。

### 2022.10.19

- 样式升级
- 图像比对参数化
- 错误案例提示

### 2022.10.23

- 增加记住密码功能，本地账号存储
- 实现用户刷新后不断开登录状态。


### 2022.10.31 

- 增加问题展示类型，不同类型的实验有不同的展示状态：图片 / iframe
- 使用Java调用Python实现的图像比对——感知哈希算法，提高图像相似度的比较。
- API接口的文档布置 + 生成

### 2022.11.15

- 实现JS实验的代码校对
- 基础思想：
  1. 规定初始HTML结构
  2. 校验初始DOM是否修改
  3. eval(StudentJS)
  4. 校验目的效果 
  5. 存储校验结果

### 2022.11.22

- JS实验的代码校对完善
- 图片缓存


### 2022.12.26

- 反复完善indexedDB数据库及localStorage数据库的校验，异步操作和同步操作的方式不同，异步操作容易堵塞，不能盲目相信别人代码对数据库的各种操作都正确。
- 通过延时验收 + 同步等待 校验的方式实现
- 增加实验的截止日期设置，若超过日期，则提交日期会标红。


### 2023.1.4

- 新增原生JS效果的查看
